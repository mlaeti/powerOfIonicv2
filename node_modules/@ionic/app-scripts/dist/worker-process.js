"use strict";
var logger_1 = require('./util/logger');
process.on('message', function (msg) {
    try {
        var modulePath = "./" + msg.task;
        var taskWorkerName = msg.task + "Worker";
        var taskWorker = require(modulePath)[taskWorkerName];
        taskWorker(msg.context, msg.workerConfig)
            .then(function (val) {
            taskResolve(msg.task, val);
        }, function (val) {
            taskReject(msg.task, val);
        })
            .catch(function (err) {
            taskError(msg.task, err);
        });
    }
    catch (e) {
        taskError(msg.task, e);
        process.exit(1);
    }
});
function taskResolve(task, val) {
    var msg = {
        task: task,
        resolve: val,
        pid: process.pid
    };
    logger_1.Logger.debug("worker resolve, task: " + msg.task + ", pid: " + msg.pid);
    process.send(msg);
}
function taskReject(task, val) {
    var msg = {
        task: task,
        reject: new logger_1.BuildError(val).toJson(),
        pid: process.pid
    };
    logger_1.Logger.debug("worker reject, task: " + msg.task + ", pid: " + msg.pid);
    process.send(msg);
}
function taskError(task, err) {
    var msg = {
        task: task,
        error: new logger_1.BuildError(err).toJson(),
        pid: process.pid
    };
    logger_1.Logger.debug("worker error, task: " + msg.task + ", pid: " + msg.pid);
    process.send(msg);
}
